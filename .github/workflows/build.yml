name: Build Unity Game & Generate Manifest

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:

env:
  UNITY_LICENSE: ${{ secrets.UNITY_LICENSE }}
  UNITY_EMAIL: ${{ secrets.UNITY_EMAIL }}
  UNITY_PASSWORD: ${{ secrets.UNITY_PASSWORD }}

jobs:
  build:
    name: Build for ${{ matrix.target }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - target: windows
            os: windows-latest
            unityPlatform: StandaloneWindows64
            extension: windows.zip

          - target: macos
            os: macos-latest
            unityPlatform: StandaloneOSX
            extension: macos.zip

          - target: linux
            os: ubuntu-latest
            unityPlatform: StandaloneLinux64
            extension: linux.zip

    steps:
      - uses: actions/checkout@v4
        with:
          lfs: true

      - uses: actions/cache@v3
        with:
          path: Library
          key: Library-${{ matrix.target }}-${{ hashFiles('**/*.cs') }}
          restore-keys: |
            Library-${{ matrix.target }}-
            Library-

      - uses: game-ci/unity-builder@v4
        with:
          unityVersion: 2023.3.0f1
          targetPlatform: ${{ matrix.unityPlatform }}

      - name: Zip Build
        run: |
          cd build/${{ matrix.unityPlatform }}
          zip -r ../../../game-${{ github.ref_name }}-${{ matrix.extension }} .
        shell: bash

      - name: Compute SHA256
        id: hash
        run: |
          HASH=$(shasum -a 256 game-${{ github.ref_name }}-${{ matrix.extension }} | cut -d ' ' -f 1)
          echo "sha256=$HASH" >> $GITHUB_OUTPUT

      - name: Upload ZIP to release
        uses: softprops/action-gh-release@v1
        with:
          files: game-${{ github.ref_name }}-${{ matrix.extension }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Store build info
        run: |
          echo "${{ matrix.target }}|game-${{ github.ref_name }}-${{ matrix.extension }}|${{ steps.hash.outputs.sha256 }}" >> build-meta.txt

      - uses: actions/upload-artifact@v3
        with:
          name: build-meta
          path: build-meta.txt

  generate-manifest:
    name: Generate latest.json manifest
    runs-on: ubuntu-latest
    needs: build
    steps:
      - uses: actions/download-artifact@v4
        with:
          name: build-meta
          path: meta

      - name: Create latest.json
        run: |
          echo '{' > latest.json
          echo '  "version": "${{ github.ref_name }}",' >> latest.json
          echo '  "zip": {' >> latest.json

          awk -F'|' '{ 
            printf "    \"%s\": {\n", $1
            printf "      \"url\": \"https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/%s\",\n", $2
            printf "      \"sha256\": \"%s\"\n", $3
            if (NR != 3) { print "    }," } else { print "    }" }
          }' meta/build-meta.txt >> latest.json

          echo '  }' >> latest.json
          echo '}' >> latest.json

      - name: Upload latest.json to release
        uses: softprops/action-gh-release@v1
        with:
          files: latest.json
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
